<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2 class="logo">
      <i class="fas fa-chart-line"></i>
      Appraise360
    </h2>
    <ul>
      <li *ngFor="let item of menuItems" (click)="navigateTo(item.route)" [class.active]="item.route === '/appraisal'">
        <i [ngClass]="['fas', item.icon]"></i> {{ item.label }}
      </li>
    </ul>
  </aside>

  <!-- Main content -->
  <div class="main">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>Appraisal Management</h1>
        <p class="subtitle">Manage employee performance appraisals and reviews</p>
      </div>
      <div class="topbar-right">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span>{{ currentUser?.fullName || 'Admin User' }}</span>
        </div>
        <button class="logout-btn" (click)="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      
      <!-- Messages -->
      <div *ngIf="errorMessage" class="message message-error">
        <i class="fas fa-exclamation-circle"></i>
        {{ errorMessage }}
      </div>
      <div *ngIf="successMessage" class="message message-success">
        <i class="fas fa-check-circle"></i>
        {{ successMessage }}
      </div>

      <!-- Appraisal Overview Cards -->
      <div class="metrics-section">
        <h2>Appraisal Overview</h2>
        <div class="cards">
          <div class="card" (click)="refreshAppraisals()">
            <div class="card-header">
              <i class="fas fa-clipboard-list icon"></i>
              <span class="trend positive">Total</span>
            </div>
            <div class="card-body">
              <div class="value">{{ appraisals.length }}</div>
              <div class="title">Total Appraisals</div>
            </div>
          </div>

          <div class="card" (click)="filterByStatus('Pending')">
            <div class="card-header">
              <i class="fas fa-clock icon"></i>
              <span class="trend negative">Pending</span>
            </div>
            <div class="card-body">
              <div class="value">{{ getAppraisalsByStatus('Pending').length }}</div>
              <div class="title">Pending Reviews</div>
            </div>
          </div>

          <div class="card" (click)="filterByStatus('Completed')">
            <div class="card-header">
              <i class="fas fa-check-circle icon"></i>
              <span class="trend positive">Completed</span>
            </div>
            <div class="card-body">
              <div class="value">{{ getAppraisalsByStatus('Completed').length }}</div>
              <div class="title">Completed Reviews</div>
            </div>
          </div>

          <div class="card" (click)="filterByStatus('In Review')">
            <div class="card-header">
              <i class="fas fa-eye icon"></i>
              <span class="trend">In Review</span>
            </div>
            <div class="card-body">
              <div class="value">{{ getAppraisalsByStatus('In Review').length }}</div>
              <div class="title">In Review</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <i class="fas fa-star icon"></i>
              <span class="trend positive">Average</span>
            </div>
            <div class="card-body">
              <div class="value">{{ getAverageRating() }}</div>
              <div class="title">Average Rating</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input 
            type="text" 
            placeholder="Search appraisals by employee name..." 
            [(ngModel)]="searchTerm"
            (input)="filterAppraisals()"
            class="search-input">
        </div>
        
        <div class="filter-controls">
          <select 
            [(ngModel)]="statusFilter" 
            (change)="filterAppraisals()"
            class="filter-select">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="In Review">In Review</option>
            <option value="Completed">Completed</option>
            <option value="Submitted">Submitted</option>
          </select>

          <button class="btn btn-secondary" (click)="clearFilters()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>

      <!-- Appraisals List -->
      <div class="appraisals-section">
        <div class="section-header">
          <h2>Recent Appraisals</h2>
          <button class="btn btn-primary" (click)="refreshAppraisals()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-section">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading appraisals...</p>
          </div>
        </div>

        <!-- Appraisals Grid -->
        <div *ngIf="!isLoading && filteredAppraisals.length > 0" class="appraisals-grid">
          <div *ngFor="let appraisal of filteredAppraisals" 
               class="appraisal-card"
               [class.selected]="selectedAppraisal?.appraisalId === appraisal.appraisalId">
            
            <div class="card-header">
              <div class="employee-info">
                <div class="employee-avatar">
                  <i class="fas fa-user"></i>
                </div>
                <div class="employee-details">
                  <h4>{{ appraisal.employee?.user?.fullName || 'Unknown Employee' }}</h4>
                  <p>{{ appraisal.employee?.department || 'N/A' }} â€¢ {{ appraisal.employee?.designation || 'N/A' }}</p>
                </div>
              </div>
              <div class="card-actions">
                <button class="btn btn-sm btn-info" (click)="viewAppraisal(appraisal)" title="View Appraisal">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" (click)="editAppraisal(appraisal)" title="Edit Appraisal">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </div>

            <div class="card-content">
              <div class="appraisal-title">
                <h3>{{ appraisal.cycleName || 'Performance Review' }}</h3>
                <span class="status-badge" [ngClass]="getStatusClass(appraisal.status)">
                  {{ appraisal.status || 'Submitted' }}
                </span>
              </div>

              <div class="rating-section">
                <div class="rating-item">
                  <span class="rating-label">Self Rating:</span>
                  <span class="rating-value" [ngClass]="getRatingClass(appraisal.selfRating)">
                    {{ appraisal.selfRating || 'N/A' }}/5
                  </span>
                </div>
                <div class="rating-item">
                  <span class="rating-label">Manager Rating:</span>
                  <span class="rating-value" [ngClass]="getRatingClass(appraisal.managerRating)">
                    {{ appraisal.managerRating || 'N/A' }}/5
                  </span>
                </div>
              </div>

              <div class="comments-section" *ngIf="appraisal.managerComments">
                <span class="comments-label">Manager Comments:</span>
                <p class="comments-text">{{ appraisal.managerComments }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && filteredAppraisals.length === 0" class="empty-state">
          <i class="fas fa-clipboard-list"></i>
          <h3>No Appraisals Found</h3>
          <p>No appraisal records match your current filters.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Manager Review Form -->
<div class="appraisal-form-section" *ngIf="selectedAppraisal">
  <div class="form-header">
    <h3>{{ canEditAppraisal(selectedAppraisal) ? 'Manager Review' : 'View Appraisal' }}</h3>
    <button class="btn btn-secondary" (click)="clearSelectedAppraisal()">
      <i class="fas fa-times"></i> Close
    </button>
  </div>
  <form [formGroup]="appraisalForm" (ngSubmit)="submitManagerReview()" class="appraisal-form">

    <!-- Employee Information (Readonly) -->
    <div class="form-section">
      <h4>Employee Information</h4>
      <div class="readonly-fields">
        <div class="form-group">
          <label>Employee ID:</label>
          <span class="readonly-value">{{ appraisalForm.get('employeeId')?.value }}</span>
        </div>
        <div class="form-group">
          <label>Full Name:</label>
          <span class="readonly-value">{{ appraisalForm.get('employeeName')?.value }}</span>
        </div>
        <div class="form-group">
          <label>Department:</label>
          <span class="readonly-value">{{ appraisalForm.get('department')?.value }}</span>
        </div>
        <div class="form-group">
          <label>Designation:</label>
          <span class="readonly-value">{{ appraisalForm.get('designation')?.value }}</span>
        </div>
      </div>
    </div>

    <!-- Appraisal Details (Readonly) -->
    <div class="form-section">
      <h4>Appraisal Details</h4>
      <div class="readonly-fields">
        <div class="form-group">
          <label>Appraisal ID:</label>
          <span class="readonly-value">{{ selectedAppraisal.appraisalId || 'N/A' }}</span>
        </div>
        <div class="form-group">
          <label>Cycle Name:</label>
          <span class="readonly-value">{{ appraisalForm.get('cycleName')?.value || 'N/A' }}</span>
        </div>
        <div class="form-group">
          <label>Appraisal Date:</label>
          <span class="readonly-value">{{ appraisalForm.get('appraisalDate')?.value | date:'short' }}</span>
        </div>
        <div class="form-group">
          <label>Review Period Start:</label>
          <span class="readonly-value">{{ appraisalForm.get('periodStart')?.value | date:'short' }}</span>
        </div>
        <div class="form-group">
          <label>Review Period End:</label>
          <span class="readonly-value">{{ appraisalForm.get('periodEnd')?.value | date:'short' }}</span>
        </div>
        <div class="form-group">
          <label>Review Date:</label>
          <span class="readonly-value">{{ appraisalForm.get('reviewDate')?.value | date:'short' }}</span>
        </div>
        <div class="form-group">
          <label>Current Status:</label>
          <span class="readonly-value status-badge" [ngClass]="getStatusClass(appraisalForm.get('status')?.value)">
            {{ appraisalForm.get('status')?.value || 'N/A' }}
          </span>
        </div>
        <div class="form-group">
          <label>Reviewer Role:</label>
          <span class="readonly-value">{{ appraisalForm.get('reviewerRole')?.value || 'N/A' }}</span>
        </div>
        <div class="form-group">
          <label>Manager Name:</label>
          <span class="readonly-value">{{ appraisalForm.get('managerName')?.value || 'N/A' }}</span>
        </div>
      </div>
    </div>

    <!-- Employee Self-Appraisal (Readonly) -->
    <div class="form-section" *ngIf="appraisalForm.get('selfRating')?.value">
      <h4>Employee Self-Appraisal</h4>
      <div class="readonly-fields">
        <div class="form-group">
          <label>Employee Rating:</label>
          <span class="readonly-value rating-display" [ngClass]="getRatingClass(appraisalForm.get('selfRating')?.value)">
            {{ appraisalForm.get('selfRating')?.value }}/5
          </span>
        </div>
        <div class="form-group">
          <label>Employee Comments:</label>
          <div class="readonly-comments">{{ appraisalForm.get('selfComments')?.value }}</div>
        </div>
      </div>
    </div>

    <!-- Manager Evaluation (Editable) -->
    <div class="form-section">
      <h4>Manager Evaluation</h4>

      <div class="form-group">
        <label for="managerRating">Manager Rating (1-5) *</label>
        <select id="managerRating" formControlName="managerRating" class="form-control">
          <option value="">Select Rating</option>
          <option value="1">1 - Needs Improvement</option>
          <option value="2">2 - Below Average</option>
          <option value="3">3 - Average</option>
          <option value="4">4 - Good</option>
          <option value="5">5 - Excellent</option>
        </select>
        <div class="error-message" *ngIf="appraisalForm.get('managerRating')?.invalid && appraisalForm.get('managerRating')?.touched">
          Please select a rating between 1 and 5
        </div>
      </div>

      <div class="form-group">
        <label for="managerComments">Manager Comments *</label>
        <textarea id="managerComments" formControlName="managerComments" class="form-control" rows="4" placeholder="Provide your evaluation and feedback..."></textarea>
        <div class="error-message" *ngIf="appraisalForm.get('managerComments')?.invalid && appraisalForm.get('managerComments')?.touched">
          Please provide comments (minimum 10 characters)
        </div>
      </div>

      <div class="form-group">
        <label for="status">Status *</label>
        <select id="status" formControlName="status" class="form-control">
          <option value="Submitted">Submitted</option>
          <option value="In Review">In Review</option>
          <option value="Completed">Completed</option>
        </select>
      </div>

      <!-- Review Cycle Dropdown -->
      <div class="form-group">
        <label for="reviewCycle">Review Cycle *</label>
        <select id="reviewCycle" formControlName="reviewCycleId" class="form-control">
          <option value="">Select Cycle</option>
          <option *ngFor="let cycle of reviewCycles" [value]="cycle.cycleId">{{ cycle.cycleName }}</option>
        </select>
        <div class="error-message" *ngIf="appraisalForm.get('reviewCycleId')?.invalid && appraisalForm.get('reviewCycleId')?.touched">
          Please select a review cycle
        </div>
      </div>

      <div class="form-group">
        <label for="reviewerRole">Reviewer Role</label>
        <input id="reviewerRole" formControlName="reviewerRole" class="form-control" readonly>
      </div>

      <div class="form-group">
        <label for="managerName">Manager Name</label>
        <input id="managerName" formControlName="managerName" class="form-control" readonly>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="selectedAppraisal = null">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="appraisalForm.invalid || isLoading">
        <i class="fas fa-save"></i> Submit Manager Review
      </button>
    </div>
  </form>
</div>